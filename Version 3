//version 3
#include <iostream>
#include <string>
#include <vector>
#include <cstdlib>  // For rand()
#include <ctime>    // For time()
using namespace std;

// Function prototypes (Chapter 6 - always use prototypes)
void welcomeMessage();
int getNumPlayers();
int getNumRounds();
void getPlayerNames(vector<string> &names, int numPlayers);
void initializeBalances(vector<int> &balances, int numPlayers, int initialBalance = 1000); // default argument
void dealInitialCards(const int numPlayers, vector<vector<string>> &playerCards,
                      vector<vector<int>> &playerCardValues);
void displayHand(const vector<string> &cards, const string &playerName, int total, bool hideSecondCard = false); // default argument
void displayHand(const vector<string> &cards, int playerIndex, int total); // overloaded
int chooseAceValue(const string &playerName);
bool playerHits(const string &playerName);
void dealerTurn(vector<string> &dealerCards, vector<int> &dealerCardValues);
int calculateTotal(const vector<int> &cardValues);
void placeBets(vector<int> &balances, vector<int> &bets, const vector<string> &names);
void sortPlayersByBalance(vector<string> &names, vector<int> &balances); // bubble sort
int linearSearchPlayer(const vector<string> &names, const string &searchName);
void exitGame();

// New helper function to draw a random card
pair<string, int> drawCard();

int main() {
    srand(time(0));  // Seed random number generator once

    welcomeMessage();

    int numPlayers = getNumPlayers();
    int numRounds = getNumRounds();

    vector<string> playerNames(numPlayers);
    vector<int> playerBalances(numPlayers);
    vector<int> playerBets(numPlayers);

    getPlayerNames(playerNames, numPlayers);
    initializeBalances(playerBalances, numPlayers);

    static int totalGamesPlayed = 0; // static variable example

    for (int round = 1; round <= numRounds; ++round) {
        cout << "\n=== Round " << round << " ===\n";

        // Reset player cards and values: 2D vectors (Chapter 7)
        vector<vector<string>> playerCards(numPlayers);
        vector<vector<int>> playerCardValues(numPlayers);

        vector<string> dealerCards;
        vector<int> dealerCardValues;

        // Place bets
        placeBets(playerBalances, playerBets, playerNames);

        // Deal initial two cards to each player (now random)
        dealInitialCards(numPlayers, playerCards, playerCardValues);

        // Deal dealer's first card (random)
        pair<string, int> dealerCard = drawCard();
        dealerCards.push_back(dealerCard.first);
        dealerCardValues.push_back(dealerCard.second);
        cout << "Dealer shows: " << dealerCards[0] << endl;

        // For each player: display hand, ask for ace value if needed, play turn
        for (int i = 0; i < numPlayers; ++i) {
            int total = 0;

            // Check for Ace in first two cards and ask for value
            for (int c = 0; c < (int)playerCards[i].size(); ++c) {
                if (playerCards[i][c] == "Ace") {
                    int aceValue = chooseAceValue(playerNames[i]);
                    playerCardValues[i][c] = aceValue;
                }
            }

            total = calculateTotal(playerCardValues[i]);

            displayHand(playerCards[i], playerNames[i], total);

            bool busted = false;
            // Player turn (hit or stand)
            while (true) {
                if (total > 21) {
                    cout << playerNames[i] << " busted!\n";
                    busted = true;
                    break;
                }
                if (!playerHits(playerNames[i]))
                    break;

                // Draw a random card now instead of hardcoded "4"
                pair<string, int> newCard = drawCard();
                playerCards[i].push_back(newCard.first);
                playerCardValues[i].push_back(newCard.second);

                // If it's an Ace, ask player for value
                if (newCard.first == "Ace") {
                    int aceValue = chooseAceValue(playerNames[i]);
                    playerCardValues[i].back() = aceValue;
                }

                total = calculateTotal(playerCardValues[i]);
                cout << playerNames[i] << " drew a " << newCard.first << ". New total: " << total << endl;
            }
            if (!busted) {
                cout << playerNames[i] << " stands with " << total << endl;
            }
        }

        // Dealer's turn
        dealerTurn(dealerCards, dealerCardValues);

        int dealerTotal = calculateTotal(dealerCardValues);
        cout << "Dealer total: " << dealerTotal << endl;

        // Determine winners and update balances
        for (int i = 0; i < numPlayers; ++i) {
            int playerTotal = calculateTotal(playerCardValues[i]);
            if (playerTotal > 21) {
                cout << playerNames[i] << " loses their bet of " << playerBets[i] << endl;
                playerBalances[i] -= playerBets[i];
            }
            else if (dealerTotal > 21 || playerTotal > dealerTotal) {
                cout << playerNames[i] << " wins and gains " << playerBets[i] << endl;
                playerBalances[i] += playerBets[i];
            }
            else if (playerTotal == dealerTotal) {
                cout << playerNames[i] << " pushes (tie), bet returned." << endl;
            }
            else {
                cout << playerNames[i] << " loses their bet of " << playerBets[i] << endl;
                playerBalances[i] -= playerBets[i];
            }
        }

        totalGamesPlayed++; // static variable usage

        cout << "\nBalances after round " << round << ":\n";
        for (int i = 0; i < numPlayers; ++i) {
            cout << playerNames[i] << ": $" << playerBalances[i] << endl;
        }

        // Allow exit after each round
        cout << "Type 'q' to quit, any other key to continue: ";
        string quitChoice;
        getline(cin, quitChoice);
        if (!quitChoice.empty() && (quitChoice[0] == 'q' || quitChoice[0] == 'Q')) {
            exitGame();
        }
    }

    // Sort players by balance at end (Chapter 8 - bubble sort)
    sortPlayersByBalance(playerNames, playerBalances);

    cout << "\nFinal rankings:\n";
    for (int i = 0; i < numPlayers; ++i) {
        cout << i + 1 << ". " << playerNames[i] << " - $" << playerBalances[i] << endl;
    }

    return 0;
}

// Helper function to draw a random card (name and value)
pair<string, int> drawCard() {
    int cardNum = rand() % 13 + 1;  // 1 to 13

    switch(cardNum) {
        case 1: return {"Ace", 11};   // Ace default 11 (can be changed by player)
        case 11: return {"Jack", 10};
        case 12: return {"Queen", 10};
        case 13: return {"King", 10};
        default: return {to_string(cardNum), cardNum};  // 2-10 cards
    }
}

// Function implementations

void welcomeMessage() {
    cout << "Welcome to Blackjack!\n";
}

int getNumPlayers() {
    int num;
    cout << "Enter number of players: ";
    cin >> num;
    cin.ignore(); // remove leftover newline
    return num;
}

int getNumRounds() {
    int rounds;
    cout << "Enter number of rounds to play: ";
    cin >> rounds;
    cin.ignore();
    return rounds;
}

void getPlayerNames(vector<string> &names, int numPlayers) {
    for (int i = 0; i < numPlayers; ++i) {
        cout << "Enter name for player " << (i + 1) << ": ";
        getline(cin, names[i]);
    }
}

void initializeBalances(vector<int> &balances, int numPlayers, int initialBalance) {
    for (int i = 0; i < numPlayers; ++i) {
        balances[i] = initialBalance;
    }
}

void dealInitialCards(const int numPlayers, vector<vector<string>> &playerCards,
                      vector<vector<int>> &playerCardValues) {
    for (int i = 0; i < numPlayers; ++i) {
        // Draw two random cards for each player
        for (int j = 0; j < 2; ++j) {
            pair<string, int> card = drawCard();
            playerCards[i].push_back(card.first);
            playerCardValues[i].push_back(card.second);
        }
        cout << playerCards[i][0] << " and " << playerCards[i][1] << " dealt to player " << i + 1 << endl;
    }
}

void displayHand(const vector<string> &cards, const string &playerName, int total, bool hideSecondCard) {
    cout << playerName << "'s hand: ";
    for (size_t i = 0; i < cards.size(); ++i) {
        if (hideSecondCard && i == 1) {
            cout << "[Second card hidden] ";
        } else {
            cout << cards[i] << " ";
        }
    }
    cout << " Total: " << total << endl;
}

void displayHand(const vector<string> &cards, int playerIndex, int total) {
    cout << "Player " << playerIndex + 1 << "'s hand: ";
    for (const string &card : cards) {
        cout << card << " ";
    }
    cout << " Total: " << total << endl;
}

int chooseAceValue(const string &playerName) {
    int val;
    cout << playerName << ", you have an Ace. Choose 1 or 11: ";
    while (true) {
        cin >> val;
        if (val == 1 || val == 11) break;
        cout << "Invalid choice. Please enter 1 or 11: ";
    }
    cin.ignore();
    return val;
}

bool playerHits(const string &playerName) {
    char choice;
    cout << playerName << ", Hit or Stand? (h/s): ";
    while (true) {
        cin >> choice;
        choice = tolower(choice);
        if (choice == 'h') {
            cin.ignore();
            return true;
        }
        else if (choice == 's') {
            cin.ignore();
            return false;
        }
        cout << "Invalid input. Enter 'h' or 's': ";
    }
}

void dealerTurn(vector<string> &dealerCards, vector<int> &dealerCardValues) {
    // Dealer draws until total >= 17
    while (calculateTotal(dealerCardValues) < 17) {
        pair<string, int> card = drawCard();
        dealerCards.push_back(card.first);
        dealerCardValues.push_back(card.second);
        cout << "Dealer drew a " << card.first << ".\n";
    }

    int total = calculateTotal(dealerCardValues);
    if (total > 21)
        cout << "Dealer busted!\n";
    else
        cout << "Dealer stands with " << total << endl;
}

int calculateTotal(const vector<int> &cardValues) {
    int sum = 0;
    for (int val : cardValues) sum += val;
    return sum;
}

void placeBets(vector<int> &balances, vector<int> &bets, const vector<string> &names) {
    for (size_t i = 0; i < names.size(); ++i) {
        cout << names[i] << ", you have $" << balances[i] << ". Enter your bet: ";
        int bet;
        while (true) {
            cin >> bet;
            if (bet > 0 && bet <= balances[i]) break;
            cout << "Invalid bet. Enter a positive amount up to your balance: ";
        }
        bets[i] = bet;
        cin.ignore();
    }
}

void sortPlayersByBalance(vector<string> &names, vector<int> &balances) {
    // Bubble sort descending by balance
    for (size_t i = 0; i < balances.size(); ++i) {
        for (size_t j = 0; j < balances.size() - 1; ++j) {
            if (balances[j] < balances[j + 1]) {
                swap(balances[j], balances[j + 1]);
                swap(names[j], names[j + 1]);
            }
        }
    }
}

int linearSearchPlayer(const vector<string> &names, const string &searchName) {
    for (size_t i = 0; i < names.size(); ++i) {
        if (names[i] == searchName) return (int)i;
    }
    return -1;
}

void exitGame() {
    cout << "Thanks for playing! Goodbye.\n";
    exit(0);
}
